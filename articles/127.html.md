---
title: 梶研 [骨格を表示する]
category: kajilab/2024年度/04月
tags:
created_at: '2024-04-28T14:15:00+09:00'
updated_at: '2024-05-06T19:04:16+09:00'
published: true
number: 127
---

# 骨格を表示する

## 出席率
- 3年セミナー：??%

## スケジュール
### 短期的な予定
- [ ] mocopi と お料理センシング
    - [x] シーンとランドマークを決める(~2月上旬)
    - [x] SVM で動作判別する
    - [ ] 機械学習を深める
        - [x] 機械学習の手法を知る
        - [x] 使う手法を決める
        - [x] データセットを探す
        - [x] LSTM してみる
        - [x] 主成分分析してみる
        - [x] クラスタリング
        - [ ] 自己相関
    - [ ] お料理センシング
        - [x] お料理でどんな動作があるかを知る
        - [x] レシピを決める
        - [ ] センシングする
        - [ ] ?
    - [ ] 論文書く
    - [ ] 発表
- [ ] BLEビーコンのuuidを書き換えたい
    - [x] 通信内容を読み解く
    - [ ] shellコマンドで通信してみる
    - [ ] 実装してみる
- [ ] BookWorm
    - [x] Pasori と デスクトップアプリを接続する(技術検証)
    - [x] nfc読み込み機能 & 画面を作る
    - [ ] API と連携させる
    - [x] 管理者画面を作る

### 長期的な予定
- ~?月 シーン検知?をする
- ~?月 論文を書く
- ~?月 論文発表したい


## 進捗報告
### 目的
料理中の動作を mocopi を使ってセンシングする。
このデータから最終的に位置推定を行う。
- 一定の区間でどの動作をしているかを当てる (クラス分類)
- 料理の手順を元にシーン検知を補正する
    - 例) 焼く動作 → 卵割る動作 はおかしい
- 位置とシーンを相補的に補正する
    - 例) 冷蔵庫の前で焼く動作 はおかしい

### 前回
骨格を表示したら、はちゃめちゃなった
<img width="407" alt="image.png (80.7 kB)" src="https://img.esa.io/uploads/production/attachments/13979/2024/04/23/148142/bd7a10f8-a1ad-4fb7-9017-adfa0469efa9.png">

角度の単位を `rad` にしてみた
<img width="407" alt="image.png (70.7 kB)" src="https://img.esa.io/uploads/production/attachments/13979/2024/04/23/148142/79274e68-8416-4101-ae7a-2c6c14aa3ded.png">
左肘以外は大丈夫ぽい？

blender で確認したら全然違った
<img width="1058.5" alt="スクリーンショット 2024-04-23 11.17.12.png (727.2 kB)" src="https://img.esa.io/uploads/production/attachments/13979/2024/04/23/148142/17da0803-8aff-4a76-8607-1a1cd479c6f6.png">

### 原因
単位は `deg`(度数法, はちゃめちゃな方) であってた
ベクトルの回転方法が正しくなかった

回転させる関数が、ベクトルのスタート位置(親関節)を考慮していなかった
例) 
腰(ROOT) の座標が `0, 0, 0`, つま先が `0, -90, 0` としたとき、
つま先を45度曲げても `0, -88, 2`(適当) 程度のはずが、
この関数は `76.58131721, -47.27897899, 0` になってしまう
```py
def rotate(vec, roll, pitch, yaw):
    r_x = np.array(
        [[1, 0, 0], [0, np.cos(roll), -np.sin(roll)], [0, np.sin(roll), np.cos(roll)]]
    )
    r_y = np.array(
        [
            [np.cos(pitch), 0, np.sin(pitch)],
            [0, 1, 0],
            [-np.sin(pitch), 0, np.cos(pitch)],
        ]
    )
    r_z = np.array(
        [[np.cos(yaw), -np.sin(yaw), 0], [np.sin(yaw), np.cos(yaw), 0], [0, 0, 1]]
    )

    vec = np.dot(r_x, vec)
    vec = np.dot(r_y, vec)
    vec = np.dot(r_z, vec)

    return vec
```

修正後
```py
def rotate(origin, end, roll, pitch, yaw):
    vec = np.array(end) - np.array(origin)

    ...

    return vec + origin
```

人間が再現できる骨格だが、不思議な姿勢
<img width="411" alt="image.png (65.2 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/04/28/148142/c5bb6359-f5b9-418a-84b8-93aea2d6009d.png">

回転をライブラリに任せる
<img width="411" alt="image.png (64.1 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/04/28/148142/33c40931-ca8b-4d4e-93db-bd0e26e2f217.png">
<img width="411" alt="image.png (71.8 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/04/28/148142/abcc58b1-3d78-4f49-9b62-25a50ead1888.png">
腕がおかしい

### リファクター
ライブラリを使って回転するようにした
```py
rot = Rotation.from_rotvec(np.array([y_rotate, x_rotate, z_rotate]))
skeleton_copy[joint]["offset"] = rot.apply(data["offset"])
```

<img width="411" alt="image.png (64.1 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/05/06/148142/481142b5-a5bf-4788-811b-fc7af4a947a0.png">

<img width="411" alt="image.png (64.4 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/05/06/148142/239a2f2f-5061-4ad9-b2f2-bacd6f858308.png">

正解
<img width="786" alt="スクリーンショット 2024-05-06 19.00.14.png (478.9 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/05/06/148142/242155d0-2855-4556-8243-7da8a95e2b8c.png">
肩のあたりが少し違う
デフォルトの姿勢は+90度(?)された状態ぽい
→ 簡単に直せるが、動作認識では問題ない(と考えられる)ため気にしない


## 進路関係


## 余談
